name: Data Quality Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'data/**'
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

# Permissions needed for auto-commit
permissions:
  contents: write
  actions: read

jobs:
  semantic-validation:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        data_check:
          #- { type_file: 'csv', name_file: 'transactions.csv', type: 'currency_usd_to_jpy', column: 'amount' }
          #- { type_file: 'json', name_file: 'temperatures.json', type: 'temperature_c_to_f', column: 'temperature' }
          # - { type_file: 'json', name_file: 'metrics.json', type: 'custom_numeric_distribution', column: 'value' }
          - { type_file: 'csv', name_file: 'sales.csv', type: 'custom_numeric_distribution', column: 'revenue' }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper commits
          fetch-depth: 0
          # Use default token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate data integrity
        uses: ./.github/actions/data-semantic-guard
        with:
          file_type: ${{ matrix.data_check.type_file }}
          file_name: ${{ matrix.data_check.name_file }}
          comparison_type: ${{ matrix.data_check.type }}
          numeric_column: ${{ matrix.data_check.column }}
          confidence_threshold: 90
        continue-on-error: true
        id: validation
      
      # Configure git for commits
      - name: Configure Git
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      # Commit baseline files (if created or updated)
      - name: Commit baseline files
        if: always()
        run: |
          # Check if baseline directory exists and has files
          if [ -d "data/baseline" ] && [ "$(ls -A data/baseline)" ]; then
            git add data/baseline/
            
            # Only commit if there are changes
            if git diff --staged --quiet; then
              echo "‚ÑπÔ∏è  No changes to baseline files"
            else
              git commit -m "chore: update data quality baselines [skip ci]
              
              Generated by GitHub Actions workflow
              Run: ${{ github.run_id }}
              Triggered by: ${{ github.event_name }}
              Commit: ${{ github.sha }}"
              
              echo "‚úÖ Committed baseline files"
            fi
          else
            echo "‚ÑπÔ∏è  No baseline files to commit"
          fi
      
      # Commit report files (always generated)
      - name: Commit report files
        if: always()
        run: |
          # Check if report directory exists and has files
          if [ -d "data/report" ] && [ "$(ls -A data/report)" ]; then
            git add data/report/
            
            # Only commit if there are changes
            if git diff --staged --quiet; then
              echo "‚ÑπÔ∏è  No changes to report files"
            else
              git commit -m "chore: update corruption detection reports [skip ci]
              
              Generated by GitHub Actions workflow
              Run: ${{ github.run_id }}
              Triggered by: ${{ github.event_name }}
              Commit: ${{ github.sha }}"
              
              echo "‚úÖ Committed report files"
            fi
          else
            echo "‚ÑπÔ∏è  No report files to commit"
          fi
      
      # Push commits back to repository
      - name: Push changes
        if: always()
        run: |
          # Check if there are any commits to push
          if git log origin/${{ github.ref_name }}..${{ github.ref_name }} --oneline | grep -q .; then
            echo "üì§ Pushing changes to repository..."
            git push origin HEAD:${{ github.ref_name }}
            echo "‚úÖ Successfully pushed baseline and report files"
          else
            echo "‚ÑπÔ∏è  No commits to push"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Upload artifact for manual download (optional backup)
      - name: Upload corruption report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corruption-reports
          path: |
            data/report/*.json
            data/baseline/*.json
          retention-days: 30
      
      # Post results summary
      - name: Post results summary
        if: always()
        run: |
          echo "## üõ°Ô∏è Data Semantic Guard Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find all report files
          REPORT_COUNT=0
          HIGH_CONFIDENCE_COUNT=0
          
          if [ -d "data/report" ]; then
            for report in data/report/*.json; do
              if [ -f "$report" ]; then
                REPORT_COUNT=$((REPORT_COUNT + 1))
                
                CONFIDENCE=$(jq -r '.metadata.confidence_score' "$report" 2>/dev/null || echo "0")
                STATUS=$(jq -r '.status' "$report" 2>/dev/null || echo "UNKNOWN")
                FILENAME=$(basename "$report")
                
                echo "### üìä Report: $FILENAME" >> $GITHUB_STEP_SUMMARY
                echo "- **Status**: $STATUS" >> $GITHUB_STEP_SUMMARY
                echo "- **Confidence**: $CONFIDENCE%" >> $GITHUB_STEP_SUMMARY
                
                if [ "$CONFIDENCE" -ge 90 ]; then
                  HIGH_CONFIDENCE_COUNT=$((HIGH_CONFIDENCE_COUNT + 1))
                  
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "#### üö® Detected Anomalies" >> $GITHUB_STEP_SUMMARY
                  jq -r '.detected_anomalies[]' "$report" 2>/dev/null | while read line; do
                    echo "- $line" >> $GITHUB_STEP_SUMMARY
                  done || true
                fi
                
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          echo "### üìà Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Reports generated: $REPORT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- High confidence detections: $HIGH_CONFIDENCE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "data/baseline" ]; then
            BASELINE_COUNT=$(ls -1 data/baseline/*.json 2>/dev/null | wc -l)
            echo "- Baseline files: $BASELINE_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä View Visualization" >> $GITHUB_STEP_SUMMARY
          echo "Visit: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files committed to repository and available at:" >> $GITHUB_STEP_SUMMARY
          echo "- \`data/baseline/\` - Baseline statistics" >> $GITHUB_STEP_SUMMARY
          echo "- \`data/report/\` - Detection reports" >> $GITHUB_STEP_SUMMARY
      
      # Fail workflow if high-confidence corruption detected
      - name: Evaluate final status
        if: always()
        run: |
          FAILED_COUNT=0
          
          if [ -d "data/report" ]; then
            for report in data/report/*.json; do
              if [ -f "$report" ]; then
                STATUS=$(jq -r '.status' "$report" 2>/dev/null || echo "UNKNOWN")
                if [ "$STATUS" = "FAILED" ]; then
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                  FILENAME=$(basename "$report")
                  echo "‚ùå Corruption detected in: $FILENAME"
                fi
              fi
            done
          fi
          
          if [ $FAILED_COUNT -gt 0 ]; then
            echo ""
            echo "‚ùå $FAILED_COUNT file(s) failed corruption detection"
            echo "üõ°Ô∏è Files have been committed to repository for review"
            exit 1
          fi
          
          echo "‚úÖ All semantic validation checks passed"